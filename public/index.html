<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <link href="css/common.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ"
        crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script type="text/javascript"
        src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=uxdaz0sqo9"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script src="/script/MarkerClustering.js"></script>

    <script>
        $().ready(function () {

        })

        function getStatusLabel(status) {
            var label = ''

            switch (status) {
                case 1:
                    label = '접수';
                    break;
                case 2:
                    label = '처리중';
                    break;
                case 3:
                    label = '완료';
                    break;
            }

            return label;
        }
    </script>
</head>

<body>
    <div class="container">
        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane show active" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                <div id="map"></div>
            </div>
        </div>

        <ul class="nav nav-pills tabs" id="pills-tab" role="tablist">
            <li class="nav-item" role="presentation">
                <a href="pages/report.html" class="nav-link" id="pills-report-tab">
                    <img src="/images/add_a_photo_black_48dp.svg" class="black">
                    제보
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a href="pages/articles.html" class="nav-link" id="pills-articles-tab">
                    <img src="/images/article_black_48dp.svg" class="black">
                    현황
                </a>
            </li>            
            <li class="nav-item" role="presentation">
                <a href="#" class="nav-link active" id="pills-index-tab">
                    <img src="/images/room_white_48dp.svg" class="white">
                    지도
                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a href="pages/news.html" class="nav-link" id="pills-news-tab">
                    <img src="/images/insert_chart_black_48dp.svg" class="black">
                    뉴스
                </a>
            </li>
        </ul>
    </div>

    <script>
        const _likes = localStorage.getItem('likes');
        const likes = _likes !== null ? JSON.parse(_likes) : [];

        const markers = [];

        var htmlMarker1 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-1.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker2 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-1.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker3 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-1.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker4 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-1.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        },
        htmlMarker5 = {
            content: '<div style="cursor:pointer;width:40px;height:40px;line-height:42px;font-size:10px;color:white;text-align:center;font-weight:bold;background:url(/images/cluster-marker-5.png);background-size:contain;"></div>',
            size: N.Size(40, 40),
            anchor: N.Point(20, 20)
        };

        var mapOptions = {
            center: new naver.maps.LatLng(36.3504119, 127.3845475),
            zoom: 16
        };

        var map = new naver.maps.Map('map', mapOptions);

        var infowindow = new naver.maps.InfoWindow();

        function onSuccessGeolocation(position) {
            var location = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);

            map.setCenter(location); // 얻은 좌표를 지도의 중심으로 설정합니다.
            map.setZoom(16); // 지도의 줌 레벨을 변경합니다.
        }

        function onErrorGeolocation() {
            var center = map.getCenter();
        }

        window.addEventListener('DOMContentLoaded', (event) => {
            var modal = new bootstrap.Modal(document.getElementById('modal'), {
                keyboard: false
            })

            if (navigator.geolocation) {
                /**
                 * navigator.geolocation 은 Chrome 50 버젼 이후로 HTTP 환경에서 사용이 Deprecate 되어 HTTPS 환경에서만 사용 가능 합니다.
                 * http://localhost 에서는 사용이 가능하며, 테스트 목적으로, Chrome 의 바로가기를 만들어서 아래와 같이 설정하면 접속은 가능합니다.
                 * chrome.exe --unsafely-treat-insecure-origin-as-secure="http://example.com"
                 */
                navigator.geolocation.getCurrentPosition(onSuccessGeolocation, onErrorGeolocation);
            } else {
                var center = map.getCenter();
                infowindow.setContent('<div style="padding:20px;"><h5 style="margin-bottom:5px;color:#f00;">Geolocation not supported</h5></div>');
                infowindow.open(map, center);
            }

            // Your web app's Firebase configuration
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
            const firebaseConfig = {
                apiKey: "AIzaSyDKn58QyDMdcfy68EOMON38O_M5Z0N9-pU",
                authDomain: "clean-together-2021.firebaseapp.com",
                databaseURL: "https://clean-together-2021-default-rtdb.firebaseio.com",
                projectId: "clean-together-2021",
                storageBucket: "clean-together-2021.appspot.com",
                messagingSenderId: "299538432144",
                appId: "1:299538432144:web:23c34e489c71aeb8509815",
                measurementId: "G-PJWLYC29GZ"
            };

            // Import the functions you need from the SDKs you need
            // TODO: Add SDKs for Firebase products that you want to use
            // https://firebase.google.com/docs/web/setup#available-libraries

            // Initialize Firebase
            const app = firebase.initializeApp(firebaseConfig);
            const db = app.database()

            var articleListRef = db.ref('articles');
            articleListRef.once('value', (snapshot) => {
                snapshot.forEach((childSnapshot) => {
                    var report = childSnapshot.val();

                    var marker = new naver.maps.Marker({
                        position: new naver.maps.LatLng(parseFloat(report.lat), parseFloat(report.lng)),
                        map: map
                    })
                    markers.push(marker);

                    marker.addListener('click', function () {
                        $('#modal .modal-body').html(applyTemplate(childSnapshot.key, childSnapshot.val()))
                        modal.show()
                    })
                });

                var markerClustering = new MarkerClustering({
                    minClusterSize: 2,
                    maxZoom: 16,
                    map: map,
                    markers: markers,
                    disableClickZoom: false,
                    gridSize: 120,
                    icons: [htmlMarker1, htmlMarker2, htmlMarker3, htmlMarker4, htmlMarker5],
                    indexGenerator: [10, 100, 200, 500, 1000],
                    stylingFunction: function(clusterMarker, count) {
                        $(clusterMarker.getElement()).find('div:first-child').text(count);
                    }
                });
            });

            $(document).on("click", ".row .like .button", function () {
                console.log('like');
                console.log($(this).closest('.row').data('key'));

                var row = $(this).closest('.row');
                var key = row.data('key');

                var current = parseInt(row.find('.count').text())
                var next;
                if (likes.includes(key)) {
                    next = current - 1;
                    row.find('.button').removeClass('active');
                    likes.splice(likes.indexOf(key), 1);
                } else {
                    next = current + 1;
                    row.find('.button').addClass('active');
                    likes.push(key);
                }
                localStorage.setItem('likes', JSON.stringify(likes));

                articleListRef.child(`${key}/like`).set(next)
                row.find('.count').text(next);
            });
        });

        function applyTemplate(key, data) {
            return `<div class="row" data-key="${key}">`
                + `    <div class="card">`
                + `        <div class="card-img-top">`
                + `            <div class="thumbnail thumbnail-before"><img src="${data["thumbnail-before"]}"></div>`
                + `            <div class="thumbnail thumbnail-after"><img src="${data["thumbnail-after"] === '' ? '../images/waiting.jpg' : data["thumbnail-after"]}"></div>`
                + `        </div>`
                + `        <div class="like py-2">`
                + `            <div class="button${likes.includes(key) ? ' active' : ''}">`
                + `                <img class="like" src="../images/favorite.svg">`
                + `                <img class="none" src="../images/favorite_border.svg">`
                + `                <span class="count">${data.like}</span>`
                + `            </div>`
                + `        </div>`
                + `        <div class="content pb-2">${data.content}</div>`
                + `        <div class="info pb-1">`
                + `            <div class="status status${data.status}">${getStatusLabel(data.status)}</div>`
                + `            <div class="address">${data.address}</div>`
                + `            <div class="created-at">${data.createdAt}</div>`
                + `        </div>`
                + `    </div>`
                + `</div>`
        }

        function getStatusLabel(status) {
            var label = ''

            switch (status) {
                case 1:
                    label = '접수';
                    break;
                case 2:
                    label = '처리중';
                    break;
                case 3:
                    label = '완료';
                    break;
            }

            return label;
        }
    </script>

    <div id="modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="pills-articles" class="modal-body">
                    
                </div>
            </div>
        </div>
    </div>
</body>

</html>
